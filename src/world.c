// Libraries
#include <consts.h>
#include <dino.h>
#include <font.h>
#include <world.h>

#include <raylib.h>
#include <raymath.h>

#include <stdlib.h>
#include <stdbool.h>
#include <string.h>

// World
world_controller world;

extern dino_controller dino;
extern bool            menu, ending;

static bool          cut = false;
static unsigned char btn = 0;

static bool          transition = false;
static unsigned int  prev       = 0;
static unsigned char alpha      = 250;

static Texture2D tilemap, scene;
static Music     music[4];
static Sound     button;

char tiles[10][256] = {
    {
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ','_',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ','_',' ',' ',' ',' ',' ',' ',' ',' ','_',' ',' ', 
        ' ','_',' ',' ',' ',' ',' ',' ',' ',' ','%',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ','@','@','@','@',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ','.','#','#','.',' ',' ',' ',' ',' ', 
        ' ',' ','_',' ',' ','%',' ','#',' ','.',' ',' ',' ',' ','_',' ', 
        ' ',' ',' ',' ',' ','@','@','#',' ','#',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','!','.','#','@','.',' ',' ',' ',' ',' ',' ', 
        ' ','_',' ',' ',' ','#','#','.','#','#',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','_',' ',' ', 
        ' ',' ',' ','_',' ',' ',' ',' ',' ','_',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
    }, 
    {
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ','_',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ','_',' ',' ','%',' ',' ',' ',' ','%',' ',' ','_',' ',' ', 
        ' ',' ',' ',' ',' ','@','@','@','@','@','@',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','#','#','.','#','#','#',' ',' ',' ',' ',' ', 
        ' ','_',' ',' ',' ','#','#','#','#','.','#',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ','#','#','#',' ','_',' ',' ',' ', 
        ' ',' ',' ',' ',' ','@','@','@','#','#','#',' ',' ',' ',' ',' ', 
        ' ',' ',' ','_',' ','!','.','#','.','#','.',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','_',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','_',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
    }, 
    {
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ','_',' ',' ',' ',' ',' ',' ',' ','_',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ','_',' ',' ',' ',' ',' ',' ','%',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','%',' ',' ','@','@','@',' ',' ','_',' ',' ', 
        ' ',' ',' ',' ',' ','@','@','@','#','#','#',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','#','#','.','#','.','#',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','.',' ','#',' ','#',' ',' ',' ',' ',' ',' ', 
        ' ',' ','_',' ',' ','#','@','.','@','#','@',' ',' ',' ','_',' ', 
        ' ',' ',' ',' ',' ','!','.','#','#','.','#',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ','_',' ',' ',' ',' ',' ',' ',' ','_',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
    }, 
    {
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ','_',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ','_',' ',' ',' ','_',' ',' ', 
        ' ',' ',' ',' ',' ','%',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','@','@',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ','_',' ',' ','!','.',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','#','.',' ',' ',' ','%',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','#','#','@','@','@','@',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','.','#','#','.','#','#',' ',' ',' ','_',' ', 
        '_',' ',' ',' ',' ','#','#','.','#','#','.',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ','_',' ',' ',' ',' ',' ',' ',' ','_',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
    }, 
    {
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ','_',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        '_',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','_',' ', 
        ' ',' ',' ',' ',' ','%',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','@','@','@','@','@',' ',' ',' ','_',' ',' ', 
        ' ',' ',' ',' ',' ','#','.','#','#','#','%',' ',' ',' ',' ',' ', 
        ' ',' ','_',' ',' ','#','#','#','.','#','@',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ','.','#','#','#',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ','#','#','.','!',' ',' ',' ',' ',' ', 
        ' ','_',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ','_',' ',' ',' ',' ','_',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
    }, 
    {
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ','_',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ','_',' ',' ','%',' ',' ',' ',' ',' ',' ',' ','_',' ',' ', 
        ' ',' ',' ',' ',' ','@','@','@','@',' ','%',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ','#','#','#','.','@','@',' ',' ',' ',' ',' ', 
        ' ','_',' ',' ',' ','#','.','#','#','.','.',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ','#','#',' ',' ','_',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ','.',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ','_',' ',' ',' ',' ','!',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','_',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','_',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
    }, 
    {
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ','%',' ',' ',' ',' ',' ',' ',' ',' ','%',' ',' ',' ', 
        ' ',' ',' ','@','@','@','@','@','@','@','@','@','@',' ',' ',' ', 
        ' ',' ',' ','#','#','#','#','#','#','#','#','#','#',' ',' ',' ', 
        ' ',' ',' ','#','#','#','#','#','#','#','#','#','!',' ',' ',' ', 
        ' ',' ',' ','#','#','#','#','#','#','#','#','#','#',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
        ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ', 
    }, 
};

struct {
    int          x, y;
    unsigned int steps;
} states[10] = {
    { 10, 5, 9  }, 
    { 5,  5, 11 }, 
    { 10, 5, 9  }, 
    { 10, 8, 11 }, 
    { 5,  6, 10 }, 
    { 5,  6, 11 }, 
    { 3,  8, 11 }, 
};

struct {
    unsigned char x, y;
    unsigned char id;
} objects[10][10] = {
    {
        { 6, 8, CONV_TILE(6, 0) }, 
    }, 
    {
        { 6, 5, CONV_TILE(6, 0) }, 
        { 9, 6, CONV_TILE(6, 0) }, 
        { 8, 6, CONV_TILE(6, 0) }, 
        { 9, 8, CONV_TILE(6, 0) }, 
    }, 
    {
        { 9, 5, CONV_TILE(6, 0) }, 
        { 7, 9, CONV_TILE(6, 0) }, 
    }, 
    {
        { 5, 9, CONV_TILE(6, 0) }, 
        { 6, 6, CONV_TILE(6, 0) }, 
        { 7, 9, CONV_TILE(3, 1) }, 
        { 8, 8, CONV_TILE(3, 1) }, 
        { 9, 9, CONV_TILE(3, 1) }, 
    }, 
    {
        { 6, 6, CONV_TILE(3, 1) }, 
        { 6, 7, CONV_TILE(3, 1) }, 
        { 9, 6, CONV_TILE(3, 1) }, 
        { 8, 7, CONV_TILE(3, 1) }, 
        { 8, 8, CONV_TILE(6, 0) }, 
    }, 
    {
        { 6, 6, CONV_TILE(3, 1) }, 
        { 6, 7, CONV_TILE(3, 1) }, 
        { 8, 7, CONV_TILE(3, 1) }, 
        { 8, 8, CONV_TILE(6, 0) }, 
    }, 
    {
        { 4,  8, CONV_TILE(6, 0) }, 
        { 5,  8, CONV_TILE(6, 0) }, 
        { 6,  8, CONV_TILE(6, 0) }, 
        { 7,  8, CONV_TILE(6, 0) }, 
        { 8,  8, CONV_TILE(6, 0) }, 
        { 9,  8, CONV_TILE(6, 0) }, 
        { 10, 8, CONV_TILE(6, 0) }, 
        { 11, 8, CONV_TILE(6, 0) }, 
    }, 
};

void world_init() {
    tilemap = LoadTexture("assets/tiles.png");
    scene   = LoadTexture("assets/scene.png");

    music[0] = LoadMusicStream("assets/bluesy.ogg");
    SetMusicVolume(music[0], 0.50f);

    music[1] = LoadMusicStream("assets/cutesy.ogg");
    SetMusicVolume(music[1], 0.50f);

    music[2] = LoadMusicStream("assets/jazzy.ogg");
    SetMusicVolume(music[2], 0.50f);
    PlayMusicStream(music[2]);

    music[3] = LoadMusicStream("assets/cwoa.ogg");
    SetMusicVolume(music[3], 0.50f);

    button = LoadSound("assets/button.ogg");

    for (unsigned int i = 0; i < 256; ++i) {
        world.tiles[i] = rand() % 11 > 8 && i % 3 ? 58 + rand() % 5 : 58;
    }

    if (!menu) {
        world.level = 0;
        world_load();
    }
}

void world_update() {
    if (ending) {
        StopMusicStream(music[0]);
    }

    if (transition) {
        if (GetTime() * 10 - prev > 15) {
            transition = false;
            cut        = true;

            PlayMusicStream(music[3]);

            plot_alpha(255);
        }
    }

    if (cut) {
        UpdateMusicStream(music[3]);

        if (GetCharPressed() && !transition) {
            transition = false;
            menu       = false;
            cut        = false;
            prev       = GetTime() * 10;

            world.level = 0;
            world_load();

            PlayMusicStream(music[0]);
        }
    } else if (menu) {
        UpdateMusicStream(music[2]);

        if (GetCharPressed() && !transition) {
            StopMusicStream(music[2]);

            PlaySound(button);
            transition = true;
            prev       = GetTime() * 10;
        }
    } else {
        UpdateMusicStream(music[0]);
    }
}

void world_draw() {
    if (transition && alpha < 250) {
        alpha += 10;
    } else if (!transition && alpha > 0) {
        alpha -= 10;
    }

    int offset = sin(GetTime() * 5) * 2;

    if (cut) {
        DrawTexture(scene, 0, 0, WHITE);
    } else if (menu) {
        for (unsigned int i = 0; i < 256; ++i) {
            Vector2   pos  = { (i % 16) * 8, (i / 16) * 8 };
            Rectangle tile = { (world.tiles[i] % 8) * 8, (world.tiles[i] / 8) * 8, 8, 8 };
            DrawTextureRec(tilemap, tile, pos, WHITE);
        }

        Vector2   pos   = { 32, 48 + offset };
        Rectangle title = { 0, 24, 64, 16 };
        DrawTextureRec(tilemap, title, pos, WHITE);

        plot_alpha(transition ? 0 : 255);
        plot_shaded(24, 70 + offset, "\x01 Any key to start \x01");

        DrawRectangle(0, 0, 128, 128, (Color){ 0, 0, 0, alpha });
    } else {
        // Draws all the world tiles
        for (unsigned int i = 0; i < 256; ++i) {
            Vector2   pos  = { (i % 16) * 8, (i / 16) * 8 };
            Rectangle tile = { (world.tiles[i] % 8) * 8, (world.tiles[i] / 8) * 8, 8, 8 };
            DrawTextureRec(tilemap, tile, pos, WHITE);
        }

        // Draws all the world objects
        for (unsigned int i = 0; i < 10; ++i) {
            Vector2   pos = { world.objs[i].x, world.objs[i].y };
            Rectangle obj = { (world.objs[i].id % 8) * 8, (world.objs[i].id / 8) * 8, 8, 8 };
            DrawTextureRec(tilemap, obj, pos, WHITE);

            double target_x = world.objs[i].grid_x * TILE_SIZE;
            double target_y = world.objs[i].grid_y * TILE_SIZE;

            if (world.objs[i].id == CONV_TILE(3, 1)) {
                world.objs[i].x = Lerp(world.objs[i].x, target_x, 0.5);
                world.objs[i].y = Lerp(world.objs[i].y, target_y, 0.5);

                if (world.objs[i].x + 1 == target_x) world.objs[i].x = target_x;
                if (world.objs[i].y + 1 == target_y) world.objs[i].y = target_y;
            } else {
                world.objs[i].x = target_x;
                world.objs[i].y = target_y;
            }
        }
    }
}

void world_start() {
    // Settings
    dino.grid_x = states[world.level].x, dino.grid_y = states[world.level].y;
    dino.steps  = states[world.level].steps;
    
    dino.keymap[0] = 0; // u
    dino.keymap[1] = 1; // d
    dino.keymap[2] = 2; // l
    dino.keymap[3] = 3; // r

    // Objects
    for (unsigned int i = 0; i < 10; ++i) {
        world.objs[i].grid_x = objects[world.level][i].x;
        world.objs[i].grid_y = objects[world.level][i].y;
        world.objs[i].id     = objects[world.level][i].id;
    }
}

void world_load() {
    // Settings
    world_start();

    // Auto-tilemapper
    for (unsigned int i = 0; i < 256; ++i) {
        unsigned char c = tiles[world.level][i];
        switch (c) {
            case ' ': {
                c = 0;
                break;
            }
            case '#': {
                c = 4;
                break;
            }
            case '.': {
                c = rand() % 3 + 1;
                break;
            }
            case '_': {
                c = rand() % 6 + 58;
                break;
            }
            case '@': {
                c = rand() % 3 + CONV_TILE(0, 1);
                break;
            }
            case '%': {
                c = CONV_TILE(7, 0);
                break;
            }
            case '!': {
                c = CONV_TILE(5, 0);
                break;
            }
        }
        world.tiles[i] = c;
    }

    // Hardcoded UI
    for (unsigned int i = CONV_WORLD(0, 12); i < 256; ++i) {
        world.tiles[i] = 0;
    }

    world.tiles[CONV_WORLD(2, 13)] = CONV_TILE(0, 5);
    world.tiles[CONV_WORLD(2, 14)] = CONV_TILE(0, 6);
    world.tiles[CONV_WORLD(3, 13)] = CONV_TILE(1, 5);
    world.tiles[CONV_WORLD(3, 14)] = CONV_TILE(1, 6);

    world.tiles[CONV_WORLD(12, 13)] = CONV_TILE(2, 5);
    world.tiles[CONV_WORLD(12, 14)] = CONV_TILE(2, 6);
    world.tiles[CONV_WORLD(13, 13)] = CONV_TILE(3, 5);
    world.tiles[CONV_WORLD(13, 14)] = CONV_TILE(3, 6);
}